<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<title>Heap CTF Theory - ducdatdau</title><meta name=Description content="just a street kid with a solid academic background"><meta property="og:title" content="Heap CTF Theory">
<meta property="og:description" content="img { box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px; border-radius: 6px; display: block; margin: 0 auto 15px; }  Nội dung bài viết sẽ không đi sâu vào nghiên cứu các cơ chế hoạt động của Heap. Thay vào đó là những nội dung khái quát, vừa đủ để người chơi có thể làm quen được với các dạng bài Heap Exploitation trong Capture The Flag.
0x1 Malloc Chunk Khi chương trình gọi hàm malloc/calloc, một vùng nhớ mới sẽ được tạo ra gọi là heap chunk.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://ducdatdau.github.io/2025-heap_ctf_theory/"><meta property="og:image" content="https://ducdatdau.github.io/logo.png"><meta property="article:section" content="research">
<meta property="article:published_time" content="2025-10-07T00:00:00+00:00">
<meta property="article:modified_time" content="2025-10-07T00:00:00+00:00"><meta property="og:site_name" content="ducdatdau blog">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://ducdatdau.github.io/logo.png">
<meta name=twitter:title content="Heap CTF Theory">
<meta name=twitter:description content="img { box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px; border-radius: 6px; display: block; margin: 0 auto 15px; }  Nội dung bài viết sẽ không đi sâu vào nghiên cứu các cơ chế hoạt động của Heap. Thay vào đó là những nội dung khái quát, vừa đủ để người chơi có thể làm quen được với các dạng bài Heap Exploitation trong Capture The Flag.
0x1 Malloc Chunk Khi chương trình gọi hàm malloc/calloc, một vùng nhớ mới sẽ được tạo ra gọi là heap chunk.">
<meta name=application-name content="Blogs">
<meta name=apple-mobile-web-app-title content="Blogs"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://github.com/ducdatdau.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ducdatdau.github.io/2025-heap_ctf_theory/><link rel=prev href=https://ducdatdau.github.io/2025-uart/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'">
<noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'">
<noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Heap CTF Theory","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ducdatdau.github.io\/2025-heap_ctf_theory\/"},"genre":"posts","keywords":"Pwnable","wordcount":1629,"url":"https:\/\/ducdatdau.github.io\/2025-heap_ctf_theory\/","datePublished":"2025-10-07T00:00:00+00:00","dateModified":"2025-10-07T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"ducdatdau"},"description":""}</script></head>
<body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'dark'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'dark'==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=ducdatdau>Home</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/misc-notes/ title="Misc Notes"> Misc Notes </a><a class=menu-item href=/research/ title=Research> Security Research </a><a class=menu-item href=/ctf-writeup/ title="CTF Writeup"> CTF </a><a class=menu-item href=/list100/ title="List 100"> List 100 </a><a class=menu-item href=/tags/> Tags </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search>
<i class="fas fa-search fa-fw" aria-hidden=true></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear>
<i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a></div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=ducdatdau>Home</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search>
<i class="fas fa-search fa-fw" aria-hidden=true></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear>
<i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span>
</div>
<a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>
Cancel
</a>
</div><a class=menu-item href=/misc-notes/ title="Misc Notes">Misc Notes</a><a class=menu-item href=/research/ title=Research>Security Research</a><a class=menu-item href=/ctf-writeup/ title="CTF Writeup">CTF</a><a class=menu-item href=/list100/ title="List 100">List 100</a><a class=menu-item href=/tags/ title>Tags</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a></div>
</div>
</header><div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div><main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>Contents</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Heap CTF Theory</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=https://ducdatdau.github.io/ title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>ducdatdau</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2025-10-07>2025-10-07</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1629 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;8 minutes&nbsp;</div><div class=post-meta-line>
<span class=post-tags-inline style="display:inline-flex;gap:.375rem;flex-wrap:wrap;margin:.5rem 0;font-weight:500"><a class="tag-badge tag-pwn" href=/tags/pwnable/ title=Pwnable><span class=tag-icon aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m14 13-7.5 7.5c-.83.83-2.17.83-3 0a2.12 2.12.0 010-3L11 10"/><path d="m16 16 6-6"/><path d="m8 8 6-6"/><path d="m9 7 8 8"/><path d="m21 11-8-8"/></svg></span><span class=tag-text>Pwnable</span></a>
</span>
</div></div><div class="details toc" id=toc-static data-kept>
<div class="details-summary toc-title">
<span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#0x1-malloc-chunk>0x1 Malloc Chunk</a></li>
<li><a href=#0x2-binning>0x2 Binning</a>
<ul>
<li><a href=#1-fast-bin>1. Fast Bin</a></li>
<li><a href=#2-tcache-bin>2. Tcache Bin</a></li>
<li><a href=#3-unsorted-bin--small-bin--large-bin>3. Unsorted Bin | Small Bin | Large Bin</a></li>
</ul>
</li>
<li><a href=#0x3-top-chunk>0x3 Top Chunk</a></li>
<li><a href=#0x4-references>0x4 References</a></li>
</ul>
</nav></div>
</div><div class=content id=content><style>img{box-shadow:rgba(0,0,0,.35)0 5px 15px;border-radius:6px;display:block;margin:0 auto 15px}</style>
<img src=./imgs/0.png>
<p>Nội dung bài viết sẽ không đi sâu vào nghiên cứu các cơ chế hoạt động của Heap. Thay vào đó là những nội dung khái quát, vừa đủ để người chơi có thể làm quen được với các dạng bài Heap Exploitation trong Capture The Flag.</p>
<h2 id=0x1-malloc-chunk>0x1 Malloc Chunk</h2>
<p>Khi chương trình gọi hàm <code>malloc</code>/<code>calloc</code>, một vùng nhớ mới sẽ được tạo ra gọi là <strong>heap chunk</strong>. Cấu trúc của một chunk sẽ gồm 2 phần: <strong>heap metadata</strong> và <strong>heap content</strong>.</p>
<p><strong>Phần 1 - Heap Metadata</strong>: Có kích thước 0x8/0x10 bytes (đối với binary 32/64 bits), chứa các thông tin như là: <strong>chunk size</strong>, <strong>flag mode</strong>, <strong>previous size</strong>.</p>
<blockquote>
<p>Trong phạm vi bài viết này, mình sẽ chỉ làm việc với binary 64 bits.</p>
</blockquote>
<ul>
<li><strong>Previous Size</strong>: Nằm ở 8 bytes đầu tiên của chunk. Chứa kích thước của chunk được <code>free</code> trước nó.</li>
<li><strong>Chunk size</strong>: Nằm ở 8 bytes tiếp theo của chunk. Chứa kích thước của chunk hiện tại (tính cả metadata).</li>
<li><strong>Flag mode</strong>: Là bit thể hiện trạng thái của chunk, được cộng vào chunk size nhưng không làm ảnh hưởng tới kích thước thật sự của chunk. Bao gồm 3 trạng thái:
<ol>
<li><strong>Previous chunk in use [0x1]</strong>: Bit này được thêm vào khi chunk phía trước đang được sử dụng.</li>
<li><strong>Is mmapped [0x2]</strong>: Kích thước chunk yêu cầu vượt quá kích thước của top chunk dẫn tới việc phải cấp phát động qua hàm <code>mmap()</code>.</li>
<li><strong>Non in main arena [0x4]</strong>: Chương trình luôn tồn tại main arena nhưng đối với chương trình multi-threading thì mỗi thread lại dùng arena riêng. Vì thế, bit này được bật khi heap chunk không nằm trong main arena.</li>
</ol>
</li>
</ul>
<p><strong>Phần 2 - Heap Content</strong>: Chứa nội dung của heap chunk.</p>
<p>Ví dụ: <code>malloc</code> 2 chunk với kích thước 0x20, tính thêm cả metadata là 0x30. Các chunk này đều có bit Previous chunk in use [0x1].</p>
<img src=./imgs/1.png>
<h2 id=0x2-binning>0x2 Binning</h2>
<p>Khi một heap chunk được <code>free</code>, nó sẽ được đẩy vào các bin tương ứng. Bin được định nghĩa là các vùng nhớ chứa các chunk được giải phóng, giúp chương trình thuận tiện cấp phát lại bộ nhớ mới khi có yêu cầu.</p>
<p>Có tổng cộng 5 bin đó là: Fast Bin, Tcache Bin, Unsorted Bin, Small Bin, Large Bin.</p>
<h3 id=1-fast-bin>1. Fast Bin</h3>
<p>Fast Bin có cấu trúc là danh sách liên kết đơn, chứa các chunk được <code>free</code> có kích thước từ <strong>[0x20, 0x80] (đã tính metadata)</strong> và hoạt động theo cơ chế LIFO - được đẩy vào sau sẽ được lấy ra trước, tương tự như cơ chế của stack.</p>
<h3 id=2-tcache-bin>2. Tcache Bin</h3>
<p>Được xuất hiện từ <strong>phiên bản Glibc 2.26</strong>, có cấu trúc tương tự như Fast Bin truyền thống. Ưu điểm so với Fast Bin đó là giữa các tiến trình sẽ phải dùng chung một Fast Bin nhưng với Tcache thì mỗi thread đều có Tcache riêng nên sẽ tối ưu hơn cho việc cấp phát lại các chunk.</p>
<p>Khi <code>free</code> một chunk có kích thước <strong>[0x20, 0x410] (đã thêm metadata)</strong> thì chunk đó sẽ được ưu tiên đẩy vào Tcache Bin trước.</p>
<p>Cấu trúc của Tcache Bin là một danh sách liên kết đơn và hoạt động theo cơ chế LIFO tương tự Fast Bin. Đối với từng kích thước, Tcache Bin sẽ chỉ chứa tối đa được 7 chunks, đây cũng chính là nhược điểm của Tcache Bin.</p>
<p>Ví dụ đoạn mã sau đây, <code>malloc</code> liên tục 8 chunks và sau đó <code>free</code> hết cả 8 chunks.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=kt>char</span> <span class=o>*</span><span class=n>ptr</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span> 

    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>ptr</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x20</span><span class=p>);</span> 
    <span class=p>}</span>

    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>free</span><span class=p>(</span><span class=n>ptr</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span> 
    <span class=p>}</span>
<span class=p>}</span> 
</code></pre></td></tr></table>
</div>
</div><p>Sau khi <code>free</code> 7 chunks có size 0x30 liên tiếp, chúng sẽ được chứa ở Tcache Bin, chunk thứ 8 sẽ bị đẩy vào Fast Bin.</p>
<img src=./imgs/2.png>
<div style=margin-bottom:1.3em></div>
<p>Khi <code>free</code> một chunk, 16 byte đầu ở Heap Content sẽ bị ghi đè.</p>
<p><strong>8 byte đầu</strong>: chứa giá trị được tính toán bởi cơ chế <strong>Safe Linking (có từ phiên bản 2.32)</strong> của Tcache theo công thức:</p>
<p>$$ v = pa \oplus (a \gg 12) $$</p>
<p>trong đó:</p>
<ul>
<li>$v$: giá trị ở 8 byte đầu sau khi <code>free</code>.</li>
<li>$pa$ - previous address: địa chỉ chunk được <code>free</code> trước đó, nếu là chunk đầu tiên được <code>free</code> thì $pa = 0$.</li>
<li>$a$: địa chỉ của chunk hiện tại.</li>
</ul>
<p>Ví dụ khi <code>free</code> chunk thứ 2:</p>
<ul>
<li>$pa$ = 0x5555555592a0</li>
<li>$a$ = 0x5555555592d0</li>
<li>$v$ = 0x5555555592a0 ^ (0x5555555592d0 &#187; 12) = 0x55500000c7f9</li>
</ul>
<img src=./imgs/4.png>
<p><strong>8 bytes sau</strong>: một giá trị Key ngẫu nhiên nhằm chống lại kỹ thuật khai thác Double Free.</p>
<h3 id=3-unsorted-bin--small-bin--large-bin>3. Unsorted Bin | Small Bin | Large Bin</h3>
<p>Ba loại bin này có mối quan hệ chặt chẽ với nhau, chúng được lưu trữ trong cùng một mảng nhưng có các vị trí khác nhau:</p>
<ul>
<li>Unsorted Bin: 0x01</li>
<li>Small Bin: 0x02 → 0x3F</li>
<li>Large Bin: 0x40 → 0x7E</li>
</ul>
<div style=margin-bottom:1.3em></div>
<p>Unsorted Bin là nơi chứa các chunk được <code>free</code> với <strong>size > 0x410</strong> (không vào được Tcache Bin) hoặc <strong>size = [0x80 - 0x410]</strong> (không vào được Fast Bin, vào được Tcache Bin nhưng đã đầy 7 chunks). Cấu trúc của nó là danh sách liên kết đôi và sẽ xử lý chunk sau khi được <code>free</code> theo 2 cách:</p>
<ol>
<li>Gộp chunk.</li>
<li>Trỏ tới chunk kế tiếp.</li>
</ol>
<div style=margin-bottom:1.3em></div>
<p><strong>Cách 1: Gộp chunk</strong></p>
<p>Nếu 2 chunks ở cạnh nhau trong Unsorted Bin, được <code>free</code> liên tiếp thì chúng sẽ được gộp lại thành 1 chunk.</p>
<img src=./imgs/3.png width=500px>
<p>Ví dụ <code>malloc</code> 2 chunks size 0x410 và <code>free</code> liên tiếp. Kết quả sẽ được một chunk có size 0x840 (đã tính metadata) trong Unsorted Bin.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=kt>char</span> <span class=o>*</span><span class=n>ptr</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span> 

    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>ptr</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x410</span><span class=p>);</span> 
    <span class=p>}</span>

    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>free</span><span class=p>(</span><span class=n>ptr</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span> 
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Sau khi <code>malloc</code> 2 chunk trên</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>pwndbg&gt; heap
Allocated chunk <span class=p>|</span> PREV_INUSE
Addr: 0x555555559000
Size: 0x290 <span class=o>(</span>with flag bits: 0x291<span class=o>)</span>

Allocated chunk <span class=p>|</span> PREV_INUSE
Addr: 0x555555559290
Size: 0x420 <span class=o>(</span>with flag bits: 0x421<span class=o>)</span>

Allocated chunk <span class=p>|</span> PREV_INUSE
Addr: 0x5555555596b0
Size: 0x420 <span class=o>(</span>with flag bits: 0x421<span class=o>)</span>
</code></pre></td></tr></table>
</div>
</div><p>Lần lượt <code>free</code> từng chunk một, kết quả sẽ cho ta thấy có sự gộp chunk.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=o>=======================</span>
<span class=o>====</span> Chunk <span class=m>1</span> <span class=nv>freed</span> <span class=o>====</span>
<span class=o>=======================</span>

pwndbg&gt; heap
Allocated chunk <span class=p>|</span> PREV_INUSE
Addr: 0x555555559000
Size: 0x290 <span class=o>(</span>with flag bits: 0x291<span class=o>)</span>

Free chunk <span class=o>(</span>unsortedbin<span class=o>)</span> <span class=p>|</span> PREV_INUSE
Addr: 0x555555559290
Size: 0x420 <span class=o>(</span>with flag bits: 0x421<span class=o>)</span>
fd: 0x7ffff7f9fce0
bk: 0x7ffff7f9fce0

Allocated chunk
Addr: 0x5555555596b0
Size: 0x420 <span class=o>(</span>with flag bits: 0x420<span class=o>)</span>

<span class=o>=======================</span>
<span class=o>====</span> Chunk <span class=m>2</span> <span class=nv>freed</span> <span class=o>====</span>
<span class=o>=======================</span>

pwndbg&gt; heap
Allocated chunk <span class=p>|</span> PREV_INUSE
Addr: 0x555555559000
Size: 0x290 <span class=o>(</span>with flag bits: 0x291<span class=o>)</span>

Free chunk <span class=o>(</span>unsortedbin<span class=o>)</span> <span class=p>|</span> PREV_INUSE
Addr: 0x555555559290
Size: 0x840 <span class=o>(</span>with flag bits: 0x841<span class=o>)</span>
fd: 0x7ffff7f9fce0
bk: 0x7ffff7f9fce0
</code></pre></td></tr></table>
</div>
</div><div style=margin-bottom:1.3em></div>
<p><strong>Cách 2: Trỏ tới chunk kế tiếp</strong></p>
<p>Khi giữa 2 chunk được <code>free</code> có một chunk đứng giữa làm “ranh giới” thì sẽ không còn hiện tượng gộp chunk. Thay vào đó các chunk sẽ nối tiếp với nhau trong danh sách liên kết đôi.</p>
<img src=./imgs/7.png>
<p>Ví dụ: <code>malloc</code> đan xen các chunk có size 0x20 và 0x410. Sau đó <code>free</code> liên tiếp các chunk có size 0x410.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=kt>char</span> <span class=o>*</span><span class=n>ptr1</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span> 
    <span class=kt>char</span> <span class=o>*</span><span class=n>ptr2</span><span class=p>[</span><span class=mi>8</span><span class=p>];</span> 

    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>ptr2</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x20</span><span class=p>);</span> 
        <span class=n>ptr1</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=mh>0x410</span><span class=p>);</span> 
    <span class=p>}</span>

    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>free</span><span class=p>(</span><span class=n>ptr1</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span> 
    <span class=p>}</span>

    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Kết quả cho thấy con trỏ <code>bk</code> và <code>fd</code> của các chunk được <code>free</code> trỏ tới nhau mà không bị gộp.</p>
<img src=./imgs/8.png>
<p>Khi một chunk được yêu cầu <code>malloc</code>, nếu Tcache Bin và Fast Bin không đáp ứng được, Unsorted Bin sẽ được xem xét đến. Có 2 trường hợp xảy ra là:</p>
<ol>
<li>Size của chunk được <code>malloc</code> (#1) &lt; Size của chunk trong Tcache Bin (#2) → Cắt một phần của Chunk #2 cho Chunk #1.</li>
<li>Ngược lại, bộ nhớ sẽ trích từ Top Chunk ra cho Chunk #1, đồng thời thực hiện đưa:</li>
</ol>
<ul>
<li>Chunk có size [0x20 - 0x410] trong Unsorted Bin → đưa vào Small Bin.</li>
<li>Chunk có size > 0x410 (#3) trong Unsorted Bin → đưa vào Large Bin.</li>
<li>Chunk trong Fast Bin
<ul>
<li>Nếu liền kề với chunk #3 → gộp chunk và cùng đưa vào Large Bin.</li>
<li>Ngược lại → đưa vào Small Bin.</li>
</ul>
</li>
</ul>
<h2 id=0x3-top-chunk>0x3 Top Chunk</h2>
<p>Top chunk là vùng nhớ lớn cuối cùng của heap dùng để giữ các khối bộ nhớ chưa được phân bổ. Khi có một yêu cầu cấp phát bộ nhớ, trình quản lý heap sẽ tìm kiếm các khối bộ nhớ đủ rộng để cấp phát. Nếu không đủ lớn, top chunk sẽ cắt một phần của mình và trả về vùng nhớ mới.</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash>pwndbg&gt; heap
Allocated chunk <span class=p>|</span> PREV_INUSE
Addr: 0x555555559000
Size: 0x290 <span class=o>(</span>with flag bits: 0x291<span class=o>)</span>

Free chunk <span class=o>(</span>tcachebins<span class=o>)</span> <span class=p>|</span> PREV_INUSE
Addr: 0x555555559290
Size: 0x20 <span class=o>(</span>with flag bits: 0x21<span class=o>)</span>
fd: 0x555555559

Allocated chunk <span class=p>|</span> PREV_INUSE
Addr: 0x5555555592b0
Size: 0x20 <span class=o>(</span>with flag bits: 0x21<span class=o>)</span>

Top chunk <span class=p>|</span> PREV_INUSE
Addr: 0x5555555592d0
Size: 0x20d30 <span class=o>(</span>with flag bits: 0x20d31<span class=o>)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=0x4-references>0x4 References</h2>
<p>[1]. <a href=https://guyinatuxedo.github.io/25-heap/index.html target=_blank rel="noopener noreffer">Heap Exploitation Nightmare</a></p>
</div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>Updated on 2025-10-07</span>
</div></div>
<div class=post-info-line>
<div class=post-info-md><span>
<a class=link-to-markdown href=/2025-heap_ctf_theory/index.md target=_blank>Read Markdown</a>
</span></div>
<div class=post-info-share>
<span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://ducdatdau.github.io/2025-heap_ctf_theory/ data-title="Heap CTF Theory" data-hashtags=Pwnable><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://ducdatdau.github.io/2025-heap_ctf_theory/ data-hashtag=Pwnable><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://ducdatdau.github.io/2025-heap_ctf_theory/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><a class="tag-badge tag-pwn" href=/tags/pwnable/ title=Pwnable><span class=tag-icon aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m14 13-7.5 7.5c-.83.83-2.17.83-3 0a2.12 2.12.0 010-3L11 10"/><path d="m16 16 6-6"/><path d="m8 8 6-6"/><path d="m9 7 8 8"/><path d="m21 11-8-8"/></svg></span><span class=tag-text>Pwnable</span></a>
</section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span>
</section>
</div>
<div class=post-nav><a href=/2025-uart/ class=prev rel=prev title="UART protocol"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>UART protocol</a></div>
</div>
</article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2024 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://ducdatdau.github.io/ target=_blank>ducdatdau</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top">
<i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments">
<i class="fas fa-comment fa-fw" aria-hidden=true></i>
</a>
</div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body>
</html>